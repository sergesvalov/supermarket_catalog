<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Supermarket Catalog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
    <div class="container py-5">
        <h2 class="mb-4">üõí –ö–∞—Ç–∞–ª–æ–≥ –¶–µ–Ω (EUR)</h2>

        <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="pills-products-tab" data-bs-toggle="pill" data-bs-target="#pills-products" type="button">üì¶ –¢–æ–≤–∞—Ä—ã</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="pills-shops-tab" data-bs-toggle="pill" data-bs-target="#pills-shops" type="button">üè™ –ú–∞–≥–∞–∑–∏–Ω—ã</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-products">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm sticky-top" style="top: 20px;">
                            <h5 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h5>
                            <form id="productForm">
                                <input type="hidden" id="productId">
                                
                                <div class="mb-3">
                                    <label class="form-label text-muted small">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" id="name" class="form-control" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label text-muted small">–ú–∞–≥–∞–∑–∏–Ω</label>
                                    <select id="shopSelect" class="form-select">
                                        <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>
                                        </select>
                                    <div class="form-text text-muted small">–ù–µ—Ç –≤ —Å–ø–∏—Å–∫–µ? –î–æ–±–∞–≤—å—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫–µ –ú–∞–≥–∞–∑–∏–Ω—ã</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label text-muted small">–¶–µ–Ω–∞ (‚Ç¨)</label>
                                    <input type="number" step="0.01" min="0" id="price" class="form-control" required>
                                </div>

                                <div class="row mb-3">
                                    <div class="col">
                                        <label class="form-label text-muted small">–í–µ—Å (–≥)</label>
                                        <input type="number" min="0" id="weight" class="form-control" placeholder="–æ–ø—Ü.">
                                    </div>
                                    <div class="col">
                                        <label class="form-label text-muted small">–ö–∫–∞–ª</label>
                                        <input type="number" min="0" id="calories" class="form-control" placeholder="–æ–ø—Ü.">
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success" id="submitBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
                                    <button type="button" class="btn btn-secondary d-none" id="cancelBtn" onclick="resetForm()">–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div id="productList"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-shops">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card p-3">
                            <h5>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞–º–∏</h5>
                            <form id="shopForm" class="d-flex gap-2 mb-3">
                                <input type="text" id="newShopName" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞" required>
                                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                            </form>
                            <ul class="list-group" id="shopList">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // === –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–û–í ===
        async function loadShops() {
            const response = await fetch('/api/shops');
            const shops = await response.json();
            
            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–µ —Ç–æ–≤–∞—Ä–∞
            const select = document.getElementById('shopSelect');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω–æ --</option>' + 
                shops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            select.value = currentVal; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –µ—Å–ª–∏ –±—ã–ª

            // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ –≤–∫–ª–∞–¥–∫–µ –ú–∞–≥–∞–∑–∏–Ω—ã
            const list = document.getElementById('shopList');
            list.innerHTML = shops.map(s => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${s.name}
                    <button class="btn btn-sm btn-danger" onclick="deleteShop(${s.id})">&times;</button>
                </li>
            `).join('');
        }

        document.getElementById('shopForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('newShopName').value;
            try {
                const res = await fetch('/api/shops', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
                document.getElementById('newShopName').value = '';
                loadShops();
            } catch (err) { alert(err.message); }
        });

        async function deleteShop(id) {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω?')) return;
            await fetch(`/api/shops/${id}`, { method: 'DELETE' });
            loadShops();
            loadProducts(); // –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã, —Ç.–∫. —É –Ω–∏—Ö –ø—Ä–æ–ø–∞–¥–µ—Ç –º–∞–≥–∞–∑–∏–Ω
        }

        // === –õ–û–ì–ò–ö–ê –¢–û–í–ê–†–û–í ===
        async function loadProducts() {
            const response = await fetch('/api/products');
            const products = await response.json();
            const list = document.getElementById('productList');
            
            list.innerHTML = products.map(p => {
                let badges = '';
                if (p.weight) badges += `<span class="badge bg-light text-dark border me-1">‚öñÔ∏è ${p.weight}–≥</span>`;
                if (p.calories) badges += `<span class="badge bg-light text-dark border">üî• ${p.calories} –∫–∫–∞–ª</span>`;
                
                // –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω –µ—Å—Ç—å, –±–µ—Ä–µ–º –∏–º—è, –∏–Ω–∞—á–µ –ø–∏—à–µ–º "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
                const shopName = p.shop ? p.shop.name : '<span class="text-muted fst-italic">–ë–µ–∑ –º–∞–≥–∞–∑–∏–Ω–∞</span>';

                return `
                <div class="card mb-2 p-3 border-0 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="m-0">${p.name}</h5>
                            <div class="mb-1">${badges}</div>
                            <small class="text-muted">${shopName} ‚Ä¢ ${new Date(p.updated_at).toLocaleDateString()}</small>
                        </div>
                        <div class="text-end ps-3">
                            <div class="fw-bold fs-5 text-success mb-1">${p.price.toFixed(2)} ‚Ç¨</div>
                            <button class="btn btn-sm btn-outline-primary" 
                                onclick="startEdit(${p.id}, '${p.name}', ${p.shop_id}, ${p.price}, ${p.weight}, ${p.calories})">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        window.startEdit = function(id, name, shopId, price, weight, calories) {
            document.getElementById('productId').value = id;
            document.getElementById('name').value = name;
            document.getElementById('shopSelect').value = shopId || ""; // –í—ã–±–∏—Ä–∞–µ–º –º–∞–≥–∞–∑–∏–Ω –≤ —Å–µ–ª–µ–∫—Ç–µ
            document.getElementById('price').value = price;
            document.getElementById('weight').value = weight || '';
            document.getElementById('calories').value = calories || '';

            document.getElementById('formTitle').innerText = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
            document.getElementById('submitBtn').innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            document.getElementById('submitBtn').classList.replace('btn-success', 'btn-primary');
            document.getElementById('cancelBtn').classList.remove('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.resetForm = function() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('formTitle').innerText = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            document.getElementById('submitBtn').innerText = '–î–æ–±–∞–≤–∏—Ç—å';
            document.getElementById('submitBtn').classList.replace('btn-primary', 'btn-success');
            document.getElementById('cancelBtn').classList.add('d-none');
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const shopVal = document.getElementById('shopSelect').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ JS —Ç–æ–∂–µ –Ω–µ –ø–æ–º–µ—à–∞–µ—Ç
            const weight = parseFloat(document.getElementById('weight').value);
            const calories = parseFloat(document.getElementById('calories').value);
            if (weight < 0 || calories < 0) {
                alert("–í–µ—Å –∏ –∫–∞–ª–æ—Ä–∏–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏!");
                return;
            }

            const data = {
                name: document.getElementById('name').value,
                shop_id: shopVal ? parseInt(shopVal) : null, // –®–ª–µ–º null –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
                price: parseFloat(document.getElementById('price').value),
                weight: weight || null,
                calories: calories || null
            };

            const url = id ? `/api/products/${id}` : '/api/products';
            const method = id ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if(!res.ok) {
                const err = await res.json();
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                alert("–û—à–∏–±–∫–∞: " + JSON.stringify(err.detail));
                return;
            }

            resetForm();
            loadProducts();
        });

        // –°—Ç–∞—Ä—Ç
        loadShops();
        loadProducts();
    </script>
</body>
</html>